#!/bin/sh
# Copyright (C) Alexander Kozhevnikov 2014-02-08;
# 
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public Licence as published by
# the Free Software Foundation, either version 3 of the licence or,
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for details.
# 
# You should've received a copy of the GNU General Public License
# with this program. If not, see <http://www.gnu.org/licences/>,
# or write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330 Boston MA 02111-1307 USA.

#TODO: 'hard' faking, with the same package name as the real thing, to deal
#with versioned 'Depends' fields / if anyone needs it.

#Function to add a file to a 'common' format 'ar' archive.
#NO support for filenames longer than 16 characters; that is unneeded for deb.
#Assumes $deb and $timestamp are within scope.
arAddFile()
{
 size=$(ls -l $1|awk '{print $5}')

 printf '%-16s%-12s0     0     100644  %-10s`\n' $1 $timestamp $size >> $deb

 cat $1 >> $deb

 #File entries must be 2-byte aligned, newline padded.
 if [ $(expr $size % 2) = 1 ]
 then
  printf '\n' >> $deb
 fi
}

#Put name of package to fake into new variable.
#Unnecessary now, will be needed once hard faking is implemented.
package="fkdep-$1"

if (printf "$package" | grep -o "[^a-z0-9+.-]")
then
 echo "^ That character is illegal in a deb package name."
 exit 1
fi

if [ "$(dpkg -s "$package" 2> /dev/null | grep -o " installed")" = " installed" ]
then
 printf "You already have a package named \"$package\" installed.\n"
 exit 2
fi

#Make new /tmp folder. If exists, append "_#"; # increments until it's unique.
base="/tmp/$package"
workDir="$base"
i=0;
while [ -e "$workDir" ]
do
 workDir="$base"_$i
 i=`expr $i + 1`
done
mkdir "$workDir"

subDir="$workDir/sub"
mkdir "$subDir"

#Using directory first as just a blank directory to generate data.tar.gz
cd "$subDir"
tar -czf "$workDir/data.tar.gz" .

#Now creating the actual DEBIAN files needed.
echo "$package (1.0) unstable; urgency=low
  * Generated by fkdep!

 -- fkdep <fkdep@example.com>  $(date -R)" > "$subDir/changelog"

echo "Source: $package
Section: metapackages
Priority: extra
Maintainer: fkdep <fkdep@example.com>
Package: $package
Provides: $1
Architecture: all
Version: 1.0
Depends: 
Description: Metapackage pretending to provide package $1
" > "$subDir/control"

echo "            DO WHAT THE FUCK YOU WANT TO PUBLIC LICENSE
                    Version 2, December 2004

 Copyright (C) 2004 Sam Hocevar <sam@hocevar.net>

 Everyone is permitted to copy and distribute verbatim or modified
 copies of this license document, and changing it is allowed as long
 as the name is changed.

            DO WHAT THE FUCK YOU WANT TO PUBLIC LICENSE
   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION

  0. You just DO WHAT THE FUCK YOU WANT TO." > "$subDir/copyright"

#Package the control files, then clean them up.
tar -czf "$workDir/control.tar.gz" .
cd "$workDir"
rm -r "$subDir"

echo "2.0" > debian-binary

#Build .deb, emulating the common 'ar' format
deb="$package.deb"
touch "$deb"
#Grab current timestamp
timestamp=$(date +%s -r "$deb")

printf "!<arch>\n" > $deb
arAddFile debian-binary
arAddFile control.tar.gz
arAddFile data.tar.gz

rm data.tar.gz control.tar.gz debian-binary

#If root, install and cleanup, if not, point user to generated deb file.
if [ $(id -u) = 0 ]
then
 dpkg -i "$deb"
 cd /
 rm -r "$workDir"
else
 printf "Did not have root permissions, can't install the deb file.\n"
 printf "You may install it manually instead, it's located at:\n"
 printf "$workDir/$deb\n"
fi
return 0
